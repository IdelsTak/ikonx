name: Calculate Version

on:
  pull_request:
    types: [closed]
    branches: ["master"]

permissions:
  contents: write

jobs:
  calculate:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.next }}

    steps:
      - uses: actions/checkout@v4

      - name: Install xmlstarlet
        run: sudo apt-get update && sudo apt-get install -y xmlstarlet

      - name: Read current version
        id: current
        run: |
          VERSION=$(xmlstarlet sel -t -v "/*[local-name()='project']/*[local-name()='version']" pom.xml)
          if [ -z "$VERSION" ]; then
            echo "Cannot read version from pom.xml"
            exit 1
          fi
          echo "value=$VERSION" >> $GITHUB_OUTPUT

      - name: Extract version label
        id: label
        run: |
          LABELS=$(jq -r '.pull_request.labels[].name' "$GITHUB_EVENT_PATH" || echo "")
          echo "$LABELS" | grep '^version:' > bump.txt || true
          COUNT=$(wc -l < bump.txt)
          if [ "$COUNT" -ne 1 ]; then
            echo "Exactly one version:* label required"
            exit 1
          fi
          echo "value=$(cat bump.txt)" >> $GITHUB_OUTPUT

      - name: Calculate next version
        id: version
        run: |
          CUR=${{ steps.current.outputs.value }}
          LABEL=${{ steps.label.outputs.value }}
          if [ -z "$CUR" ]; then
            echo "Current version is empty, cannot bump"
            exit 1
          fi

          IFS='.' read MA MI PA <<< "${CUR%%-*}"
          PRE="${CUR#*-}"
          case "$LABEL" in
            version:major) NEXT="$((MA+1)).0.0" ;;
            version:minor) NEXT="$MA.$((MI+1)).0" ;;
            version:patch) NEXT="$MA.$MI.$((PA+1))" ;;
            version:alpha) NEXT="$MA.$MI.$PA-alpha" ;;
            version:beta)  NEXT="$MA.$MI.$PA-beta" ;;
            version:rc)    NEXT="$MA.$MI.$PA-rc" ;;
            *) echo "Unknown label $LABEL"; exit 1 ;;
          esac

          echo "next=$NEXT" >> $GITHUB_OUTPUT

      - name: Update pom.xml with new version
        id: update-pom
        run: |
          NEXT=${{ steps.version.outputs.next }}
          echo "Updating pom.xml to version $NEXT"
          xmlstarlet ed -L -u "/*[local-name()='project']/*[local-name()='version']" -v "$NEXT" pom.xml
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pom.xml
          git commit -m "ci: bump version to $NEXT"
          git push
